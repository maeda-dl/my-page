<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>社員紹介＋おみくじ</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
html, body {
  margin:0; padding:0; height:100%;
  font-family:'Playfair Display', serif;
  font-weight:700;
  background:#ffffff;
  overflow:hidden;
  transition: background 1s ease;
  -webkit-user-select:none;
  -ms-user-select:none;
  user-select:none;
}
#particles { position:fixed; top:0; left:0; width:100%; height:100%; z-index:1; }
.container { position:relative; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; height:100%; padding:1em; z-index:2; perspective:500px; }
.message, #name { opacity:0; margin:0.5em 0; font-weight:bold; transition:opacity 1s ease, transform 0.1s ease; text-align:center; }
#msg1 { font-size:calc(20px + 2vw); }
#dataLine { font-size:calc(22px + 2vw); font-family:'Pacifico', cursive; display:inline-block; font-weight:bold; letter-spacing:2px; perspective:500px; }
#dataLine span { color:navy; display:inline-block; animation: shimmer 1.5s linear infinite; text-shadow:1px 1px 0 #222, 2px 2px 3px rgba(0,0,0,0.6), -1px -1px 1px rgba(255,255,255,0.2); }
@keyframes shimmer { 0%,80%,100% { color:navy; text-shadow:1px 1px 0 #222,2px 2px 3px rgba(0,0,0,0.6),-1px -1px 1px rgba(255,255,255,0.2);} 40% { color:silver; text-shadow:0 0 8px rgba(192,192,192,0.8),1px 1px 0 #222,2px 2px 5px rgba(0,0,0,0.6);} }
#name { font-size:calc(22px + 2vw); }
.image-wrapper { margin-top:1em; position:relative; width:90%; max-width:400px; }
.image { display:block; width:100%; height:auto; position:absolute; top:0; left:0; opacity:0; transition:opacity 0.8s ease; border-radius:10px; }
#omikujiBtn {
  position: fixed; bottom: 20%; left: 50%; transform: translate(-50%,0);
  min-width: 220px; padding: 12px 25px; font-size: 22px; font-weight: bold;
  border: none; border-radius: 50px;
  background: linear-gradient(145deg, #1a2a6c, #0f1b4c); color: #fff; cursor: pointer;
  z-index: 4; display: none; white-space: nowrap; text-align: center; box-sizing: border-box;
  font-family: 'Playfair Display', serif;
}
#probBtn { 
  position: fixed; 
  bottom:20px; right:20px; padding:10px 15px; 
  font-size:16px; 
  font-family: 'Playfair Display', serif;
  border:none; border-radius:8px; background: linear-gradient(145deg, #0f1b4c, #1a2a6c); color:#fff; cursor:pointer; display:none; z-index:4; }
#history { display:none; position: fixed; bottom:20px; left:20px; font-size:16px; background:#fff; color:#0f1b4c; padding:5px 10px; border-radius:8px; max-width:250px; z-index:99999; text-align:center; word-break:break-word; }
#probPopup { position: fixed; bottom: -500px; left:50%; transform:translateX(-50%); width:280px; max-height:400px; overflow-y:auto; background:#0f1b4c; color:#fff; font-size:16px; padding:15px; z-index:999999; text-align:left; border-radius:16px; border:2px solid silver; box-shadow:0 8px 20px rgba(0,0,0,0.3); transition:bottom 0.4s ease; }
#probPopup.open { bottom: 80px; }
#probPopup .probLine { display:flex; justify-content:space-between; padding:6px 10px; margin:5px 0; background:rgba(255,255,255,0.05); border-radius:6px; font-weight:bold; }
#roulette { position: fixed; bottom:30%; left:50%; transform:translateX(-50%); width:90%; max-width:200px; height:70px; display:none; align-items:center; justify-content:center; z-index:99998; border-radius:30px; overflow:hidden; background:#fefefe; border:3px solid #0f1b4c; }
#rouletteInner { display:flex; white-space:nowrap; font-size:28px; font-weight:bold; will-change: transform; }
.fortune { min-width:130px; height:60px; margin:0 5px; color:#0f1b4c; font-size:22px; display:flex; align-items:center; justify-content:center; }
#resultDisplay { 
  position:fixed; 
  top:50%; 
  left:50%; 
  transform:translate(-50%,-50%) translateY(40px);
  font-size:60px; font-weight:bold; text-align:center; display:none; 
  z-index:99999; color:#ff4500; text-shadow:2px 2px 10px rgba(0,0,0,0.3); 
}
#resetModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,0.95); border-radius:16px; padding:20px 25px; box-shadow:0 8px 20px rgba(0,0,0,0.3); text-align:center; z-index:1000000; font-family:'Playfair Display', serif; }
#resetModal p { font-size:18px; margin-bottom:20px; }
#resetModal button { margin:0 10px; padding:8px 20px; border:none; border-radius:10px; font-size:16px; cursor:pointer; }
#modalYes { background:#1a2a6c; color:#fff; }
#modalNo { background:#ccc; color:#000; }
#broom { position:absolute; font-size:30px; display:none; z-index:99999; pointer-events:none; }
#hintBtn { position:fixed; top:10px; right:10px; font-size:28px; z-index:999999; cursor:pointer; display:none; }
#hintPopup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:300px; background:#ffffff; color:#0f1b4c; border-radius:16px; padding:20px; box-shadow:0 0 20px rgba(0,0,0,0.6); text-align:left; font-weight:bold; z-index:1000000; font-family:'Playfair Display', serif; }
#hintPopup p { margin:8px 0; }
</style>
</head>
<body>

<canvas id="particles"></canvas>

<div class="container">
  <div id="msg1" class="message">はじめまして</div>
  <div id="dataLine" class="message">Data Line</div>
  <div id="name">前田だよ</div>
  <div class="image-wrapper">
    <img id="imgA" class="image" src="A.png" alt="画像A">
    <img id="imgB" class="image" src="B.png" alt="画像B">
  </div>
</div>

<div id="roulette"><div id="rouletteInner"></div></div>
<div id="resultDisplay"></div>
<div id="history"></div>

<button id="omikujiBtn">おみくじを引く ✨</button>
<button id="probBtn">確率詳細</button>

<div id="probPopup"></div>

<div id="resetModal">
  <p>おみくじ履歴をリセットしますか？</p>
  <button id="modalYes">Yes</button>
  <button id="modalNo">No</button>
</div>

<div id="broom">🧹</div>
<div id="hintBtn">🔔</div>
<div id="hintPopup">
  <p>ある機能が隠れてるよ</p>
  <p>色々操作して探してね</p>
  <br>
  <p>①おみくじを引く</p>
  <p>②確率詳細ボタン</p>
  <p>③背景色変更</p>
  <p>④おみくじ履歴リセット</p>
</div>

<script>
// --- 粒子 ---
const canvas=document.getElementById("particles");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth; canvas.height=window.innerHeight;
const particleChars="MAEDA";
let particles=[];
for(let i=0;i<100;i++){
  particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*2+1,dx:(Math.random()-0.5)*1.2,dy:(Math.random()-0.5)*1.2,char:particleChars[Math.floor(Math.random()*particleChars.length)]});
}
function drawParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="rgba(80,80,80,0.8)";
  particles.forEach(p=>{
    ctx.font=`${p.r*6}px sans-serif`;
    ctx.fillText(p.char,p.x,p.y);
    p.x+=p.dx; p.y+=p.dy;
    if(p.x<0||p.x>canvas.width)p.dx*=-1;
    if(p.y<0||p.y>canvas.height)p.dy*=-1;
  });
  requestAnimationFrame(drawParticles);
}
drawParticles();
window.addEventListener("resize",()=>{canvas.width=window.innerWidth; canvas.height=window.innerHeight;});

// --- フェードイン ---
function fadeIn(el,delay){ setTimeout(()=>{el.style.opacity=1;}, delay);}
fadeIn(document.getElementById("msg1"),500);
const dataLine=document.getElementById("dataLine");
dataLine.innerHTML=dataLine.textContent.split('').map((c,i)=>`<span style="animation-delay:${i*0.2}s">${c}</span>`).join('');
fadeIn(dataLine,2000);
fadeIn(document.getElementById("imgA"),5000);

// --- 画像切替 ---
setTimeout(()=>{
  const imgA=document.getElementById("imgA");
  const imgB=document.getElementById("imgB");
  const name=document.getElementById("name");
  imgA.style.zIndex=2; imgB.style.zIndex=1;
  imgA.style.opacity=1; imgB.style.opacity=0; name.style.opacity=1;
  let showA=true;
  setInterval(()=>{
    showA=!showA;
    if(showA){
      imgA.style.zIndex=2; imgB.style.zIndex=1; imgA.style.opacity=1; imgB.style.opacity=0;
    } else{
      imgB.style.zIndex=2; imgA.style.zIndex=1; imgB.style.opacity=1; imgA.style.opacity=0;
    }
  },2000);

  document.getElementById("omikujiBtn").style.display="inline-block";
  document.getElementById("probBtn").style.display="inline-block";
  document.getElementById("hintBtn").style.display="block";
},8000);

// --- 💘 表示 ---
const heartEl = document.createElement('div');
heartEl.textContent = '💘';
heartEl.style.position = 'absolute';
heartEl.style.fontSize = '16px';
heartEl.style.zIndex = 9999;
heartEl.style.pointerEvents = 'none'; 
heartEl.style.display = 'none';
document.body.appendChild(heartEl);
let heartTimeout = null;

function showHeartIfFacingDown(beta){
  const imgB = document.getElementById('imgB');
  if(imgB.style.opacity !== "1") return;
  if(beta < 160 || beta > 200) return;
  if(heartTimeout) return;
  const rect = imgB.getBoundingClientRect();
  heartEl.style.left = `${rect.left + rect.width/2 - 8}px`;
  heartEl.style.top = `${rect.top + 35}px`;
  heartEl.style.display = 'block';
  heartTimeout = setTimeout(()=>{
    heartEl.style.display = 'none';
    heartTimeout = null;
  }, 300);
}

// --- 傾き ---
let targetX=0,targetY=0,currentX=0,currentY=0;
window.addEventListener('deviceorientation', (e)=>{
  targetY = e.gamma/2;
  targetX = e.beta/3;
  const container = document.querySelector('.container');
  container.style.transform = `rotateX(${currentX}deg) rotateY(${currentY}deg)`;
  currentY+=(targetY-currentY)*0.15;
  currentX+=(targetX-currentX)*0.15;

  // 💘表示
  showHeartIfFacingDown(e.beta);
});
function animateTilt(){ requestAnimationFrame(animateTilt); }
animateTilt();

// --- おみくじ ---
const fortunes=[{name:"大吉 🎉",probability:0.05},{name:"中吉 😀",probability:0.1},{name:"小吉 🙂",probability:0.2},{name:"吉 😊",probability:0.4},{name:"末吉 😌",probability:0.2},{name:"凶 😱",probability:0.04},{name:"大凶 💀",probability:0.01}];
const fortuneCounts={}; fortunes.forEach(f=>fortuneCounts[f.name]=0);
const probBtn=document.getElementById("probBtn");
const probPopup=document.getElementById("probPopup");
function updateProbPopup(){ probPopup.innerHTML=fortunes.map(f=>`<div class="probLine"><span>${f.name}</span><span>${(f.probability*100).toFixed(1)}% (${fortuneCounts[f.name]}回)</span></div>`).join(""); }
probBtn.addEventListener("click",()=>{updateProbPopup(); probPopup.classList.toggle("open");});
document.body.addEventListener("click",(e)=>{if(probPopup.classList.contains("open") && e.target!==probBtn && !probPopup.contains(e.target)){ probPopup.classList.remove("open");}});

const roulette=document.getElementById("roulette");
const rouletteInner=document.getElementById("rouletteInner");
const resultDisplay=document.getElementById("resultDisplay");
const history=document.getElementById("history");
const btn=document.getElementById("omikujiBtn");
let totalCount=0;

// --- 特別粒子管理 ---
let specialParticlesAdded = false;
let specialParticles = [];

function pickFortune(){ const rand=Math.random(); let sum=0; for(let f of fortunes){ sum+=f.probability; if(rand<=sum) return f.name; } return fortunes[fortunes.length-1].name; }

btn.addEventListener("click", ()=>{
  btn.style.display="none";
  roulette.style.display="block";
  rouletteInner.innerHTML="";
  rouletteInner.style.transition='none';
  rouletteInner.style.transform='translateX(0)';
  rouletteInner.offsetHeight;
  for(let i=0;i<20;i++){ fortunes.forEach(f=>{ const div=document.createElement("div"); div.className="fortune"; div.textContent=f.name; rouletteInner.appendChild(div);});}
  const selectedName=pickFortune();
  const allFortunes=rouletteInner.querySelectorAll(".fortune");
  let stopIndex=Math.floor(allFortunes.length*0.8)+fortunes.findIndex(f=>f.name===selectedName);
  const selectedDiv=allFortunes[stopIndex];
  const offset=-selectedDiv.offsetLeft+(roulette.offsetWidth/2)-(selectedDiv.offsetWidth/2);
  selectedDiv.classList.add('selected');
  rouletteInner.style.transition=`transform 1200ms cubic-bezier(0.25,0.1,0.25,1)`;
  rouletteInner.style.transform=`translateX(${offset + 50}px)`;
  
  setTimeout(()=>{
    rouletteInner.style.transition=`transform 800ms ease-out`;
    rouletteInner.style.transform=`translateX(${offset}px)`;
    setTimeout(()=>{
      totalCount++; 
      fortuneCounts[selectedName]++;
      setTimeout(()=>{
        roulette.style.display="none";
        resultDisplay.textContent = selectedName;
        resultDisplay.style.display = "block";
        setTimeout(()=>{
          resultDisplay.style.display="none";
          btn.style.display="inline-block";
          history.textContent=`${selectedName}（${fortuneCounts[selectedName]}回目 / ${totalCount}回中）`;
          history.style.display="block";
          selectedDiv.classList.remove('selected');

          if(totalCount === 15){
            specialParticles = [];
            for(let i=0;i<5;i++){
              const p = { x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1, dx: (Math.random()-0.5)*1.5, dy: (Math.random()-0.5)*1.5, char: "(☆▽☆)" };
              particles.push(p);
              specialParticles.push(p);
            }
            specialParticlesAdded = true;
          }

          if(totalCount > 15 && specialParticlesAdded){
            specialParticles.forEach(p=>{ const idx=particles.indexOf(p); if(idx>-1) particles.splice(idx,1); });
            specialParticlesAdded=false;
          }

        },3000);
      },1000);
    },1300);
  },1200);
});

// --- 背景色 ---
const bgColors=["#fef6f0","#e6f7ff","#f0fff0","#fff0f5","#fffaf0","#f5f5dc","#ffffff"];
let bgIndex=0;
function nextBackgroundColor(){ document.body.style.background=bgColors[bgIndex]; bgIndex=(bgIndex+1)%bgColors.length; }

// --- シェイク ---
let shakeTimes=0,lastShakeTime=0,lastAcc={x:0,y:0,z:0};
const modal=document.getElementById("resetModal");
const btnYes=document.getElementById("modalYes");
const btnNo=document.getElementById("modalNo");
const shakeWindow=500;
function handleMotion(event){
  const acc=event.accelerationIncludingGravity;
  if(!acc) return;
  const diffX=acc.x-lastAcc.x;
  const diffY=acc.y-lastAcc.y;
  const diffZ=acc.z-lastAcc.z;
  const totalDiff=Math.sqrt(diffX*diffX+diffY*diffY+diffZ*diffZ);
  lastAcc={x:acc.x,y:acc.y,z:acc.z};
  const threshold=25;
  const now=Date.now();
  if(totalDiff>threshold){ if(now-lastShakeTime<=shakeWindow){ shakeTimes++; } else{ shakeTimes=1; } lastShakeTime=now; if(shakeTimes===2) nextBackgroundColor(); }
}
function initDeviceMotion(){
  if(typeof DeviceMotionEvent.requestPermission==='function'){
    DeviceMotionEvent.requestPermission().then(response=>{ if(response==='granted'){ window.addEventListener('devicemotion', handleMotion);}}).catch(console.error);
  } else { window.addEventListener('devicemotion', handleMotion);}
}
document.body.addEventListener("click",initDeviceMotion,{once:true});

// --- DataLine 長押し ---
const broom=document.getElementById("broom");
let longPressTimer=null;
dataLine.addEventListener("touchstart",(e)=>{
  const touch=e.touches[0];
  broom.style.left=`${touch.clientX-15}px`;
  broom.style.top=`${touch.clientY-15}px`;
  broom.style.display="block";
  longPressTimer=setTimeout(()=>{ modal.style.display="block"; },5000);
});
dataLine.addEventListener("touchmove",(e)=>{ e.preventDefault(); const touch=e.touches[0]; broom.style.left=`${touch.clientX-15}px`; broom.style.top=`${touch.clientY-15}px`; });
dataLine.addEventListener("touchend",(e)=>{ broom.style.display="none"; clearTimeout(longPressTimer); });

// --- リセットモーダル ---
btnYes.addEventListener("click",()=>{
  for(let key in fortuneCounts) fortuneCounts[key]=0;
  totalCount=0;
  history.style.display="none";
  resultDisplay.style.display="none";
  roulette.style.display="none";
  updateProbPopup();
  document.body.style.background="#ffffff";
  modal.style.display="none";
});
btnNo.addEventListener("click",()=>{ modal.style.display="none"; });

// --- ヒント ---
const hintBtn=document.getElementById("hintBtn");
const hintPopup=document.getElementById("hintPopup");
hintBtn.addEventListener("click",()=>{ hintPopup.style.display=hintPopup.style.display==="block"?"none":"block"; });
document.body.addEventListener("click",(e)=>{
  if(hintPopup.style.display==="block" && !hintPopup.contains(e.target) && e.target!==hintBtn){
    hintPopup.style.display="none";
  }
});
</script>
</body>
</html>
